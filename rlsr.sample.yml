releases:
  - name: "Release to github"
    # The dist folder where the builds will be stored.
    dist_folder: "./dist"
    builds_sequential: false
    # The targets where the builds will be released.
    targets:
      github:
        owner: "iamd3vil"
        repo: "rlsr"
      gitlab:
        owner: "namespace" # or username
        repo: "project-name"
        # url: "https://gitlab.example.com" # Optional: for self-hosted GitLab (defaults to https://gitlab.com)
      docker:
        image: "localhost:5000/rlsr"
        dockerfile: "./Dockerfile"
        context: "."
    # The checksum algorithm to use.
    checksum:
      algorithm: "sha256"
    # These additional files will be included with all the builds.
    additional_files:
      - "README.md"
      - "LICENSE"
    env:
      - "RUSTFLAGS=-C target-cpu=native"
    # Global hooks for the release. Will be run before any build.
    hooks:
      before:
        - "cargo check"
      after:
        - "echo 'Release complete'"
    builds:
      - command: "cargo build --release"
        bin_name: "rlsr" # Optional, defaults to the archive name.
        artifact: "./target/release/rlsr" # The artifact to archive and release.
        archive_name: "rlsr-linux-x86_64" # Archive name.
        no_archive: false # If turned true, will not archive the artifact.

        # Archive format: zip (default), tar_gz, tar_zstd, or tar_lz4.
        # Can also use "tar.gz", "tar.zstd", "tar.lz4" with quotes.
        archive_format: tar_gz

        prehook: "generate_docs.sh" # Optional, a script to run before the build.
        posthook: "posthook.sh"

        env:
          - "BUILD_ENV=production"

        # Build specific additional files.
        additional_files:
          - "README.md"
          - "LICENSE"

      - name: "Docker buildx image"
        type: "buildx"
        artifact: "./target/buildx/rlsr-image.tar"
        archive_name: "rlsr-image-{{ meta.tag }}.tar"
        no_archive: true
        buildx:
          context: "."
          dockerfile: "./Dockerfile"
          builder: "rlsr-builder"
          platforms:
            - "linux/amd64"
            - "linux/arm64"
          tags:
            - "localhost:5000/rlsr:{{ meta.tag }}"
          outputs:
            - "type=tar,dest=./target/buildx/rlsr-image.tar"
          cache_from:
            - "type=registry,ref=localhost:5000/rlsr:buildcache"
          cache_to:
            - "type=inline"
          build_args:
            RUST_VERSION: "{{ meta.version }}"
          labels:
            org.opencontainers.image.title: "rlsr"
          target: "release"
          provenance: true
          sbom: false

# The changelog will be generated from the git log.
changelog:
  format: "github"
  # An optional template can be used to format the changelog.
  template: "changelog.tpl"
  # exclude the commits which match the regexes.
  exclude:
    - "^doc:"
